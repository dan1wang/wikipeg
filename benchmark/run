#!/usr/bin/env node
/* eslint-disable no-console */
"use strict";

const fs   = require("fs");
const PEG_STABLE  = require("wikipeg-stable");
const PEG_EDGE  = require("wikipeg");

const benchmarks = require("./benchmarks.js");
const Runner = require("./runner.js");

/* Results Table Manipulation */

function dup(text, count) {
  var result = "";
  for (var i = 1; i <= count; i++) {
    result += text;
  }
  return result;
}

function padLeft(text, length) {
  return dup(" ", length - text.length) + text;
}

function padRight(text, length) {
  return text + dup(" ", length - text.length);
}

function center(text, length) {
  var padLength = (length - text.length) / 2;
  return dup(" ", Math.floor(padLength))
    + text
    + dup(" ", Math.ceil(padLength));
}

function writeTableHeader() {
  console.log("┌─────────────────────────────────────┬───────────┬────────────┬──────────────┐");
  console.log("│                Test                 │ Inp. size │ Avg. time  │  Avg. speed  │");
}

function writeHeading(heading) {
  console.log("├─────────────────────────────────────┴───────────┴────────────┴──────────────┤");
  console.log("│ " + center(heading, 75) + " │");
  console.log("├─────────────────────────────────────┬───────────┬────────────┬──────────────┤");
}

function writeResult(title, inputSize, parseTime) {
  var KB      = 1024;
  var MS_IN_S = 1000;

  console.log("│ "
    + padRight(title, 35)
    + " │ "
    + padLeft((inputSize / KB).toFixed(2), 6)
    + " kB │ "
    + padLeft(parseTime.toFixed(2), 7)
    + " ms │ "
    + padLeft(((inputSize / KB) / (parseTime / MS_IN_S)).toFixed(2), 7)
    + " kB/s │"
  );
}

function writeSeparator() {
  console.log("├─────────────────────────────────────┼───────────┼────────────┼──────────────┤");
}

function writeTableFooter() {
  console.log("└─────────────────────────────────────┴───────────┴────────────┴──────────────┘");
}

/* Helpers */

function printHelp() {
  console.log("Usage: run [options]");
  console.log("");
  console.log("Runs WikiPEG benchmark suite.");
  console.log("");
  console.log("Options:");
  console.log("  -n, --run-count <n>          number of runs (default: 10)");
  console.log("      --cache                  make tested parsers cache results");
}

function exitSuccess() {
  process.exit(0);
}

function exitFailure() {
  process.exit(1);
}

function abort(message) {
  console.error(message);
  exitFailure();
}

/* Arguments */

var args = process.argv.slice(2); // Trim "node" and the script path.

function isOption(arg) {
  return (/^-/).test(arg);
}

function nextArg() {
  args.shift();
}

/* Main */

var runCount = 10;
var options = {
  cache:    false
};

while (args.length > 0 && isOption(args[0])) {
  switch (args[0]) {
    case "-n":
    case "--run-count":
      nextArg();
      if (args.length === 0) {
        abort("Missing parameter of the -n/--run-count option.");
      }
      runCount = parseInt(args[0], 10);
      if (isNaN(runCount) || runCount <= 0) {
        abort("Number of runs must be a positive integer.");
      }
      break;

    case "--cache":
      options.cache = true;
      break;

    case "-h":
    case "--help":
      printHelp();
      exitSuccess();
      break;

    default:
      abort("Unknown option: " + args[0] + ".");
  }
  nextArg();
}

if (args.length > 0) {
  abort("No arguments are allowed.");
}

const RunnerCallBacks = {
  readFile: function(file) {
    return fs.readFileSync(__dirname + "/" + file, "utf8");
  },

  testStart: function(/*benchmark, test*/) {
    /* Nothing to do. */
  },

  testFinish: function(benchmark, test, inputSize, parseTime) {
    writeResult(test.title, inputSize, parseTime);
  },

  benchmarkStart: function(benchmark) {
    writeHeading(benchmark.title);
  },

  benchmarkFinish: function(benchmark, inputSize, parseTime) {
    writeSeparator();
    writeResult(benchmark.title + " total", inputSize, parseTime);
  },

  start: function() {
    writeTableHeader();
  },

  finish: function(inputSize, parseTime) {
    writeSeparator();
    writeResult("Total", inputSize, parseTime);
    writeTableFooter();
  },
};

console.log("Testing latest release (stable)");
Runner(PEG_STABLE).run(benchmarks, runCount, options, RunnerCallBacks);

console.log("Testing current build (edge)");
Runner(PEG_EDGE).run(benchmarks, runCount, options, RunnerCallBacks);
